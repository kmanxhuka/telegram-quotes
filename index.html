<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Telegram Quotes</title>

<!-- Google Fonts: Aref Ruqaa and Montserrat -->
<link href="https://fonts.googleapis.com/css2?family=Aref+Ruqaa&family=Montserrat&display=swap" rel="stylesheet" />

<style>
  :root {
    --bg-color: #f0f0f0;
    --container-bg: #fff;
    --text-color: #271c14;
    --progress-gradient: linear-gradient(90deg, #4caf50, #8bc34a);
  }

  body {
    background: var(--bg-color);
    font-family: Arial, sans-serif;
    display: flex;
    height: 100vh;
    margin: 0;
    justify-content: center;
    align-items: center;
    transition: background 0.5s ease;
  }

  #quote-container {
    background: var(--container-bg);
    padding: 2rem;
    max-width: 700px;
    width: 90%;
    box-shadow: 0 0 20px rgb(0 0 0 / 0.1);
    border-radius: 10px;
    user-select: none;
    position: relative;
    transition: background 0.5s ease;
  }

  /* Theme toggle button */
  #theme-toggle {
  position: fixed;
  top: 15px;
  right: 15px;
  background: none;
  border: none;
  cursor: pointer;
  font-size: 1.8rem;
  color: var(--text-color);
  transition: color 0.3s ease;
  z-index: 1000;
}

  #quote-title {
    font-family: 'Montserrat', Arial, sans-serif;
    direction: ltr;
    text-align: center;
    font-size: 1.6rem;
    margin-bottom: 0.5rem;
    color: var(--text-color);
    transition: color 0.5s ease;
  }

  hr {
    width: 50%;
    margin: 10px auto;
    border: none;
    border-top: 1px solid #ccc;
  }

  @font-face {
    font-family: 'AmiriArabic';
    src: local('Amiri'), local('Scheherazade New'), local('Times New Roman');
    unicode-range: U+0600-06FF, U+0750-077F, U+08A0-08FF, U+FB50-FDFF, U+FE70-FEFF;
  }

  #quote-body {
    font-family: 'Josefin Sans', 'AmiriArabic', sans-serif;
    white-space: pre-wrap;
    font-size: 2rem;
    line-height: 1.5;
    text-align: center;
    color: var(--text-color);
    transition: color 0.5s ease;
  }

  .arabic-text {
    font-family: 'Aref Ruqaa', serif;
    direction: rtl;
    unicode-bidi: embed;
    display: inline-block;
  }

  #progress-container {
    height: 6px;
    background: #ddd;
    border-radius: 3px;
    margin-top: 1.5rem;
    overflow: hidden;
  }

  #progress-bar {
    height: 100%;
    background: var(--progress-gradient);
    width: 100%;
    animation: progressShrink 30s linear forwards;
  }

  @keyframes progressShrink {
    from { width: 100%; }
    to { width: 0%; }
  }

  /* Night theme */
  body.night {
    --bg-color: #121212;
    --container-bg: #1e1e1e;
    --text-color: #f5f5f5;
    --progress-gradient: linear-gradient(90deg, #2196f3, #64b5f6);
  }
</style>
</head>
<body>
  <div id="quote-container">
    <button id="theme-toggle" title="Toggle Theme">‚òÄÔ∏è</button>
    <div id="quote-title">Loading...</div>
    <hr />
    <div id="quote-body"></div>
    <div id="progress-container">
      <div id="progress-bar"></div>
    </div>
  </div>

<script>
  const titleEl = document.getElementById('quote-title');
  const bodyEl = document.getElementById('quote-body');
  const progressBar = document.getElementById('progress-bar');
  const themeToggleBtn = document.getElementById('theme-toggle');
  let timerId = null;
  let manualOverride = false;

  // Wrap Arabic text chunks with RTL span and arabic-text class
  function wrapArabicText(html) {
    const arabicRegex = /([\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]+)/g;
    return html.replace(arabicRegex, (match) => {
      return `<span class="arabic-text" dir="rtl">${match}</span>`;
    });
  }

  async function loadQuote() {
    try {
      const res = await fetch('/quotes');
      const data = await res.json();

      if (data.length > 0) {
        titleEl.textContent = data[0].title || 'Quote';
        bodyEl.innerHTML = wrapArabicText(data[0].html || '');

        // Dynamic refresh timing
        const textLength = bodyEl.innerText.length;
        const baseTime = 2;
        const extraPerChar = 0.2;
        let refreshTime = baseTime + (textLength / 3) * extraPerChar;
        if (refreshTime > 60) refreshTime = 60;
        if (refreshTime < 2) refreshTime = 2;

        resetProgressBar(refreshTime);

        if (timerId) clearTimeout(timerId);
        timerId = setTimeout(loadQuote, refreshTime * 1000);
      } else {
        titleEl.textContent = 'No Quotes Available';
        bodyEl.textContent = '';
        progressBar.style.width = '0%';
      }
    } catch (err) {
      console.error(err);
    }
  }

  function resetProgressBar(seconds) {
    progressBar.style.animation = 'none';
    progressBar.offsetHeight; // force reflow
    progressBar.style.animation = `progressShrink ${seconds}s linear forwards`;
  }

  // Auto Theme Switching for Suhareka
  async function setThemeByTime() {
    if (manualOverride) return;

    const lat = 42.36;
    const lon = 20.82;

    try {
      const res = await fetch(`https://api.sunrise-sunset.org/json?lat=${lat}&lng=${lon}&formatted=0`);
      const data = await res.json();

      const sunrise = new Date(data.results.sunrise);
      const sunset = new Date(data.results.sunset);
      const now = new Date();

      if (now >= sunset || now <= sunrise) {
        document.body.classList.add('night');
        themeToggleBtn.textContent = 'üåô';
      } else {
        document.body.classList.remove('night');
        themeToggleBtn.textContent = '‚òÄÔ∏è';
      }
    } catch (err) {
      console.error('Error fetching sunrise/sunset:', err);
    }
  }

  // Manual theme toggle
  themeToggleBtn.addEventListener('click', () => {
    document.body.classList.toggle('night');
    manualOverride = true;
    themeToggleBtn.textContent = document.body.classList.contains('night') ? 'üåô' : '‚òÄÔ∏è';
  });

  loadQuote();
  setThemeByTime();
  setInterval(setThemeByTime, 60 * 60 * 1000); // every hour
</script>
</body>
</html>

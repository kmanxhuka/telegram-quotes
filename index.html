<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SHTEGU.IM Quotes</title>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Aref+Ruqaa&family=Montserrat&display=swap" rel="stylesheet" />

<style>
  :root {
    --bg-color: #f0f0f0;
    --container-bg: #fff;
    --text-color: #271c14;
    --progress-gradient: linear-gradient(90deg, #4caf50, #8bc34a);
  }

  body {
    background: var(--bg-color);
    font-family: Arial, sans-serif;
    display: flex;
    height: 100vh;
    margin: 0;
    justify-content: center;
    align-items: center;
    transition: background 0.5s ease;
  }

  #quote-container {
    background: var(--container-bg);
    padding: 2rem;
    max-width: 700px;
    width: 90%;
    box-shadow: 0 0 20px rgb(0 0 0 / 0.1);
    border-radius: 10px;
    text-align: center;
    position: relative;
    transition: background 0.5s ease;
  }

  /* Logo in top-left */
  #logo {
    position: fixed;
    top: 15px;
    left: 15px;
    height: 96px;
    transition: opacity 0.5s ease;
  }

  /* Theme toggle button in top-right */
  #theme-toggle {
    position: fixed;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.8rem;
    color: var(--text-color);
    transition: color 0.3s ease;
    z-index: 1000;
  }

  #quote-title {
    font-family: 'Montserrat', sans-serif;
    font-size: 1.6rem;
    margin-bottom: 0.5rem;
    color: var(--text-color);
    transition: color 0.5s ease;
  }

  hr {
    width: 50%;
    margin: 10px auto;
    border: none;
    border-top: 1px solid #ccc;
  }

  #quote-body {
    font-family: 'Aref Ruqaa', serif;
    white-space: pre-wrap;
    font-size: 2rem;
    line-height: 1.5;
    text-align: center;
    color: var(--text-color);
    transition: color 0.5s ease;
  }

  #progress-container {
    height: 6px;
    background: #ddd;
    border-radius: 3px;
    margin-top: 1.5rem;
    overflow: hidden;
  }

  #progress-bar {
    height: 100%;
    background: var(--progress-gradient);
    width: 100%;
    animation: progressShrink 30s linear forwards;
  }

  @keyframes progressShrink {
    from { width: 100%; }
    to { width: 0%; }
  }

  /* Night theme */
  body.night {
    --bg-color: #121212;
    --container-bg: #1e1e1e;
    --text-color: #f5f5f5;
    --progress-gradient: linear-gradient(90deg, #2196f3, #64b5f6);
  }
</style>
</head>
<body>
  <!-- Logo -->
  <img id="logo" src="day-logo.png" alt="Logo" />

  <!-- Theme toggle button -->
  <button id="theme-toggle" title="Toggle Theme">‚òÄÔ∏è</button>

  <div id="quote-container">
    <div id="quote-title">Loading...</div>
    <hr />
    <div id="quote-body"></div>
    <div id="progress-container">
      <div id="progress-bar"></div>
    </div>
  </div>

<script>
  const titleEl = document.getElementById('quote-title');
  const bodyEl = document.getElementById('quote-body');
  const progressBar = document.getElementById('progress-bar');
  const themeToggleBtn = document.getElementById('theme-toggle');
  const logoEl = document.getElementById('logo');

  let timerId = null;
  let manualOverride = false;

  async function loadQuote() {
    try {
      const res = await fetch('/quotes');
      const data = await res.json();

      if (data.length > 0) {
        titleEl.textContent = data[0].title || 'Quote';
        bodyEl.innerHTML = data[0].html || '';

        // Dynamic refresh timing
        const textLength = bodyEl.innerText.length;
        const baseTime = 2;
        const extraPerChar = 0.2;
        let refreshTime = baseTime + (textLength / 3) * extraPerChar;
        if (refreshTime > 60) refreshTime = 60;
        if (refreshTime < 2) refreshTime = 2;

        resetProgressBar(refreshTime);

        if (timerId) clearTimeout(timerId);
        timerId = setTimeout(loadQuote, refreshTime * 1000);
      } else {
        titleEl.textContent = 'No Quotes Available';
        bodyEl.textContent = '';
        progressBar.style.width = '0%';
      }
    } catch (err) {
      console.error(err);
    }
  }

  function resetProgressBar(seconds) {
    progressBar.style.animation = 'none';
    progressBar.offsetHeight; // force reflow
    progressBar.style.animation = `progressShrink ${seconds}s linear forwards`;
  }

  // Switch theme automatically
  async function setThemeByTime() {
    if (manualOverride) return;

    const lat = 42.36;
    const lon = 20.82;

    try {
      const res = await fetch(`https://api.sunrise-sunset.org/json?lat=${lat}&lng=${lon}&formatted=0`);
      const data = await res.json();

      const sunrise = new Date(data.results.sunrise);
      const sunset = new Date(data.results.sunset);
      const now = new Date();

      if (now >= sunset || now <= sunrise) {
        setNightTheme();
      } else {
        setDayTheme();
      }
    } catch (err) {
      console.error('Error fetching sunrise/sunset:', err);
    }
  }

  function setNightTheme() {
    document.body.classList.add('night');
    themeToggleBtn.textContent = 'üåô';
    logoEl.src = 'night-logo.png';
  }

  function setDayTheme() {
    document.body.classList.remove('night');
    themeToggleBtn.textContent = '‚òÄÔ∏è';
    logoEl.src = 'day-logo.png';
  }

  // Manual theme toggle
  themeToggleBtn.addEventListener('click', () => {
    document.body.classList.toggle('night');
    manualOverride = true;

    if (document.body.classList.contains('night')) {
      setNightTheme();
    } else {
      setDayTheme();
    }
  });

  loadQuote();
  setThemeByTime();
  setInterval(setThemeByTime, 60 * 60 * 1000); // every hour
</script>
</body>
</html>
